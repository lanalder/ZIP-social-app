/*! frontend 2021-09-17 */

$(document).ready(function(){let s,a=new Array(5),t={},n;const o=["title","descript","img_url","user_id","author"],r=document.querySelector("#albumOutput");$.ajax({url:"config.json",type:"GET",dataType:"json",success(e){s=`${e.SERVER_URL}:${e.SERVER_PORT}`,u()},error(e){console.log(e)}});const i=()=>sessionStorage.getItem("user_id")?a.every(e=>e):(alert("Please login to perform this action"),!1),l=()=>{for(let e=0;e<5;e++)Object.defineProperty(t,o[e],{value:a[e],enumerable:!0,configurable:!0})},c=(e,t)=>{$.ajax({url:e,type:"GET",dataType:"json",success(e){console.log(e),t(e)},error(e,t){console.log(e,t)}})},d=(e,t,a)=>{$.ajax({url:e,type:"POST",dataType:"json",data:t,success(e){a(e)},error(e,t){console.log(e,t)}})},m=e=>{var t=sessionStorage.getItem("user_id");t?d(`${s}/likePost/${n}`,{user_id:t},function(){e.firstChild.classList.toggle("fa-heart-o"),e.firstChild.classList.toggle("fa-heart"),e.firstChild.classList.toggle("active-icon")}):alert("Please login or register to interact with posts :)")},u=()=>{const e=sessionStorage.getItem("user_id");c(`${s}/allPosts`,function(t){e?c(`${s}/hasLiked/${e}`,function(e){e=e.map(e=>Object.values(e)).flat(),p(t,e)}):p(t,!1)})},p=(t,a)=>{let o;r.innerHTML="";for(let e=t.length-1;e>=t.length-20;--e){var s=t[e],i=t[e].author[0];o=a.includes(s._id)?"fa-heart active-icon":"fa-heart-o",r.innerHTML+=`<div class="col-md-4">
        <div class="card mb-4">
          <img class="card-img-top" src="${s.img_url}" alt="" style="width: 100%">
          <div class="card-img-overlay d-flex">
            <div class="expand-container text-wrap">
              <i class="${s._id} interaction-icon view fa fa-expand" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#viewFullImageModal"></i>
            </div>
            <div class="col-8 overlay-container d-flex justify-content-center">
              <img class="rounded-circle overlay-profile-image" src="${i.profl_pic}" alt="" width="50" height="50">
              <div class="overlay-text-container">
                <h4 class="overlay-username d-block">${i.username}</h4>
                <p class="overlay-imagename d-block">${s.title}</p>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="like-comment-container d-flex justify-content-between">
              <p class="${s._id} like interaction-icon like-counter interaction-icon"><i class="${s._id} fa ${o} like" aria-hidden="true"></i> ${s.stats.likes.length}</p>
              <p class="${s._id} comment interaction-icon comment-counter interaction-icon"><i class="${s._id} comment fa fa-commenting-o" aria-hidden="true"></i> ${s.stats.comments}</p>
              <p class="${s._id} edit interaction-icon"><i class="${s._id} edit fa fa-pencil" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#editModal"></i></p>
              <p class="${s._id} delete interaction-icon"><i class="${s._id} delete fa fa-trash-o" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#deleteModal""></i></p>
            </div>
            <p class="card-text">${s.descript}</p>
            <div class="comments-container">
              <div class="comments-output">
              </div>
              <div class="comment-field">
              </div>
            </div>
          </div>
        </div>
      </div>`}Array.from(document.querySelectorAll(".interaction-icon")).forEach(t=>{t.addEventListener("click",function(e){n=e.target.classList[0],e.target.classList.contains("comment")?g(t):e.target.classList.contains("like")?m(t):e.target.classList.contains("view")&&f(t)},!1)})},g=e=>{const o=e.parentElement.parentElement.parentElement;console.log(o,e,n),c(`${s}/seeComments/${n}`,function(t){o.firstElementChild.innerHTML="",console.log(t);for(let e=0;e<t.length-1;e++){var a=t[e];o.innerHTML+=`
          <div class="${a._id} comment-container border-bottom">
            <a href="/myprofle#${a.user_id}"<h6 class="comment-username">${a.author}</h6></a>
            <p class="comment-text">${a.text}</p>
            <p class="comment-time">${a.time}</p>
          </div>`}o.innerHTML+=`<div class="form-group mb-3" style="z-index: 1">
          <label for="newComment" class="form-label new-comment-label">
            <h6>Post New Comment</h6>
          </label>
          <textarea class="form-control" id="newComment" rows="3" maxlength="160" placeholder="Maximum 160 Characters"></textarea>
          <p class="${n} post-comment text-end send-comment-btn"><i class="${n} post-comment fa fa-paper-plane text-end" aria-hidden="true"></i></p>
        </div>`,Array.from(document.querySelectorAll(".post-comment")).forEach(e=>{e.addEventListener("click",function(e){var t;t=e,(e=sessionStorage.getItem("user_id"))?d(`${s}/createComment`,{author:sessionStorage.getItem("username"),text:document.querySelector("#newComment").value,user_id:e,post_id:t.target.classList[0]},function(){}):alert("Please login or register to interact with posts :)")},!1)})})};document.querySelector("#addPostBtn").addEventListener("click",function(e){Array.from(document.querySelectorAll(".addField")).forEach((e,t)=>{a[t]=$(e).val()}),a[3]=sessionStorage.getItem("user_id"),a[4]=sessionStorage.getItem("username"),l(),i()?(d(`${s}/postPost`,JSON.stringify(t),function(){}),$.ajax({url:`${s}/postPost`,type:"POST",data:JSON.stringify(t),contentType:"application/json",success(e){alert("Your project has been successfully added!"),window.location.reload()},error(e){alert("You are not authorised to perform this action")}})):alert("Please fill out all fields")},!1),document.querySelector("#editConfirmBtn").addEventListener("click",function(e){Array.from(document.querySelectorAll(".editField")).forEach((e,t)=>{a[t]=$(e).val()}),l(),i()?$.ajax({url:`${s}/editPost/${n}`,type:"PATCH",data:JSON.stringify(t),contentType:"application/json",success(e){"401: user has no permission to update"==e?alert(e):(alert("Post has been updated"),window.location.reload())},error(){console.log("error: cannot call api")}}):alert("Please fill in all fields")},!1),document.querySelector("#deleteConfirmBtn").addEventListener("click",function(e){sessionStorage.getItem("user_id")?$.ajax({url:`${s}/deletePost/${n}`,type:"DELETE",data:{user_id:sessionStorage.getItem("user_id")},success(e){"deleted"==e?(alert("Post has been deleted"),window.location.reload()):console.log("Post was not found")},error(){console.log("error: cannot call api")}}):alert("You do not have permission to delete this post")},!1);const f=e=>{document.querySelector(".fullImage").src=e.parentElement.parentElement.parentElement.firstElementChild.src,document.querySelector(".view-title").innerHTML=e.parentElement.nextElementSibling.lastElementChild.lastElementChild.innerText}});