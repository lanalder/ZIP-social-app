/*! frontend 2021-09-23 */

$(document).ready(function(){let o,i=new Array(4),t={},l,r={get id(){return sessionStorage.getItem("user_id")},get name(){return sessionStorage.getItem("username")}},s=new Map;const n=["title","img_url","descript","user_id"],c=document.querySelector("#albumOutput");$.ajax({url:"config.json",type:"GET",dataType:"json",success(e){o=`${e.SERVER_URL}:${e.SERVER_PORT}`,f()},error(e){console.log(e)}});const a=()=>r.id?i.every(e=>e):(alert("Please login to perform this action"),!1),d=()=>{for(let e=0;e<4;e++)Object.defineProperty(t,n[e],{value:i[e],enumerable:!0,configurable:!0})},m=(e,t)=>{$.ajax({url:e,type:"GET",dataType:"json",success(e){t(e)},error(e){console.log(e)}})},u=(e,t,i,n)=>{$.ajax({url:e,type:t,dataType:"json",data:JSON.stringify(i),contentType:"application/json",success(e){n(e)},error(e){console.log(e)}})},f=()=>{let e=window.location.hash.substring(1);"me"==e&&(e=r.id),m(`${o}/userPosts/${e}`,function(i){r.id?m(`${o}/hasLiked/${r.id}`,function(t){t=t.map(e=>Object.values(e)).flat(),m(`${o}/getUser/${r.id}`,function(e){p(i,t,e)})}):p(i,!1,!1)})},p=(t,i,e)=>{let n,a;if(c.innerHTML="",!t.length)return document.querySelector(".profile-image").src=e.profl_pic,void(document.querySelector(".myprofile-header").innerHTML=`${e.username}`);for(let e=t.length-1;0<=e;--e){var o=t[e],s=t[0].author[0];n=i&&i.includes(o._id)?"fa-heart active-icon":"fa-heart-o",a=r.id!==o.user_id?"display-none":"",c.innerHTML+=`<div class="col-md-4">
        <div class="card mb-4">
          <img class="card-img-top" src="${o.img_url}" alt="" style="width: 100%">
          <div class="card-img-overlay d-flex">
            <div class="expand-container text-wrap">
              <i class="${o._id} interaction-icon view fa fa-expand" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#viewFullImageModal"></i>
            </div>
            <div class="col-8 overlay-container d-flex justify-content-center">
              <img class="rounded-circle overlay-profile-image" src="${s.profl_pic}" alt="" width="50" height="50">
              <div class="overlay-text-container">
                <h4 class="overlay-username d-block">${s.username}</h4>
                <p class="overlay-imagename d-block">${o.title}</p>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="like-comment-container d-flex justify-content-between">
              <p class="${o._id} like interaction-icon like-counter interaction-icon"><i class="${o._id} fa ${n} like" aria-hidden="true"></i> ${o.stats.likes.length}</p>
              <p class="${o._id} comment interaction-icon comment-counter interaction-icon"><i class="${o._id} comment fa fa-commenting-o" aria-hidden="true"></i> ${o.stats.comments}</p>
              <p class="${o._id} ${a} edit interaction-icon"><i class="${o._id} edit fa fa-pencil" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#editModal"></i></p>
              <p class="${o._id} ${a} delete interaction-icon"><i class="${o._id} delete fa fa-trash-o" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#deleteModal""></i></p>
            </div>
            <p class="card-text">${o.descript}</p>
            <div class="comments-container">
              <div class="comments-themselves"></div>
              <div class="comment-field"></div>
            </div>
          </div>
        </div>
      </div>`}Array.from(document.querySelectorAll(".interaction-icon")).forEach(t=>{t.addEventListener("click",function(e){e.preventDefault(),l=e.target.classList[0],e.target.classList.contains("comment")?g(t):e.target.classList.contains("like")?h(t):e.target.classList.contains("view")&&v(t)},!0)})},h=t=>{var i;r.id?t.firstChild.classList.contains("active-icon")?(i=t,u(`${o}/unlikePost/${l}`,"POST",{user_id:r.id},function(){var e=parseInt(i.textContent)-1;i.innerHTML=`<p class="${l} like interaction-icon like-counter interaction-icon"><i class="${l} fa fa-heart-o like" aria-hidden="true"></i> ${e}</p>`})):u(`${o}/likePost/${l}`,"POST",{user_id:r.id},function(){var e=parseInt(t.textContent)+1;t.innerHTML=`<p class="${l} like interaction-icon like-counter interaction-icon"><i class="${l} fa fa-heart active-icon like" aria-hidden="true"></i> ${e}</p>`}):alert("Please login or register to interact with posts :)")},g=n=>{const a=n.parentElement.parentElement.lastElementChild,e=s.get(l)+1;if(s.has(l)?s.set(l,e):s.set(l,0),s.get(l)%2)return a.firstElementChild.innerHTML="",void(a.lastElementChild.innerHTML="");m(`${o}/seeComments/${l}`,function(t){a.firstElementChild.innerHTML="";for(let e=0;e<t.length;e++){var i=t[e];a.firstElementChild.innerHTML+=`
        <div class="${i._id} comment-output border-bottom">
          <a href="/myprofle#${i.user_id}"<h6 class="comment-username">${i.author}</h6></a>
          <p class="comment-text">${i.text}</p>
          <p class="comment-time">${i.time}</p>
        </div>`}a.lastElementChild.innerHTML||(a.lastElementChild.innerHTML=`<div class="form-group mb-3" style="z-index: 1"> <label for="newComment" class="form-label new-comment-label"> <h6>Post New Comment</h6> </label>
          <textarea class="form-control" id="newComment" rows="3" maxlength="160" placeholder="Maximum 160 Characters"></textarea>
          <p class="${l} post-comment text-end send-comment-btn"><i class="${l} fa fa-paper-plane text-end" aria-hidden="true"></i></p>
        </div>`,document.querySelector(".post-comment").addEventListener("click",function(e){((e,t)=>{if(r.id){const i=s.get(e.classList[0])+1;s.set(e.classList[0],i);u(`${o}/createComment`,"POST",{author:r.name,text:document.querySelector("#newComment").value,user_id:r.id,post_id:e.classList[0]},function(){g(t)})}else alert("Please login or register to interact with posts :)")})(e.target,n)},!0))})};document.querySelector("#addConfirmBtn").addEventListener("click",function(e){Array.from(document.querySelectorAll(".addField")).forEach((e,t)=>{i[t]=$(e).val()}),i[3]=sessionStorage.getItem("user_id"),d(),a()?(u(`${o}/postPost`,"POST",t,function(e){e?(console.log(e),alert("Your project has been successfully added!"),window.location.reload()):alert("You are not authorised to perform this action")}),console.log("hello?")):alert("Please fill out all fields")},!1),document.querySelector("#editConfirmBtn").addEventListener("click",function(e){Array.from(document.querySelectorAll(".editField")).forEach((e,t)=>{i[t]=$(e).val()}),i[3]=sessionStorage.getItem("user_id"),d(),console.log(i,i.every(e=>e),t),a()?u(`${o}/editPost/${l}`,"PATCH",t,function(e){"401: user has no permission to update"==e?alert(e):(alert("Post has been updated"),window.location.reload())}):alert("Please fill in all fields")},!1),document.querySelector("#deleteConfirmBtn").addEventListener("click",function(e){r.id?$.ajax({url:`${o}/deletePost/${l}`,type:"DELETE",data:{user_id:r.id},success(e){console.log(e),"deleted"==e?(alert("Post has been deleted"),window.location.reload()):alert("Post was not found")},error(e){console.log(e)}}):alert("You do not have permission to delete this post")},!1);const v=e=>{document.querySelector(".fullImage").src=e.parentElement.parentElement.parentElement.firstElementChild.src,document.querySelector(".view-title").innerHTML=e.parentElement.nextElementSibling.lastElementChild.lastElementChild.innerText}});